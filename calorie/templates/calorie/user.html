{% extends "calorie/layout.html" %}

{% block body %}
    <script>
        let currentFoodData = null;
        let currentComputedMacros = null;

        document.addEventListener("DOMContentLoaded", function(){
            document.querySelector("#search").onkeyup = function() {
                const query = document.querySelector("#search").value;

                if (query.length >= 1) {
                    fetch(`/search-foods?q=${query}`)
                    .then(response => response.json())
                    .then(data => {
                        const resultsContainer = document.querySelector("#search-results");
                        resultsContainer.innerHTML = ""

                        data.results.forEach(food => {
                            const foodElement = document.createElement("div");
                            foodElement.innerHTML = `
                            <div class="card food-card" data-bs-toggle="modal" data-bs-target="#foodDetailModal" data-food-id="${food.id}" style="margin-top: 20px; cursor: pointer;">
                                <div class="card-body" style="text-align: left;">
                                    <div class="row">
                                        <div class="col-11">
                                            <h3><strong>${food.name}</strong></h3>
                                            <h5>${food.calories}kcal</h5>
                                            <h5>${food.protein}P  ${food.carbs}C  ${food.fats}F</h5>
                                        </div>
                                        <div class="col-1" style="padding-top: 30px; padding-bottom: 30px;" >
                                            <h3> > </h3>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            `
                            resultsContainer.append(foodElement)
                        });
                    })
                }
                else {
                    document.querySelector("#search-results").innerHTML = "";
                }
            };

            let currentDate = new Date("{{ date|date:'Y-m-d' }}");
            document.querySelector("#previous").onclick = function() {
                currentDate.setDate(currentDate.getDate() - 1);
                window.location.href = `/user?date=${currentDate.toISOString().split("T")[0]}`;
            }
            document.querySelector("#next").onclick = function() {
                currentDate.setDate(currentDate.getDate() + 1);
                window.location.href = `/user?date=${currentDate.toISOString().split("T")[0]}`;
            }

            document.addEventListener("click", function(event){
                const card = event.target.closest(".food-card");
                if (card){
                    const foodId = card.dataset.foodId;
                    console.log("Clicked food ID:", foodId);
                    const modalElement = document.querySelector("#foodDetailModal");
                    if (modalElement) {
                        const foodDetailModal = bootstrap.Modal.getOrCreateInstance(modalElement);
                        foodDetailModal.show();
                    } else {
                        console.error("Modal element #foodDetailModel not found in DOM");
                    }
                    fetch(`/food-details/${foodId}`)
                    .then(response => response.json())
                    .then(data => {
                        console.log(data);
                        currentFoodData = data;

                        document.querySelector("#modalFoodName").innerHTML = `<h1><strong>${data.name}</strong></h1>`;
                        document.querySelector("#modalFoodDetails").innerHTML = `
                            <div class="mb-3">
                                <h1 id="calories">${data.calories}kcal</h1>
                                <h2 id="macros">${data.protein}P  ${data.carbs}C  ${data.fats}F</h2>
                            </div>
                        `;

                        const unitSelect = document.querySelector("#unitSelect");

                        unitSelect.innerHTML = ""
                        const baseOption = document.createElement("option");
                        baseOption.value = data.base_unit;  
                        baseOption.textContent = data.base_unit;
                        baseOption.selected = true;
                        unitSelect.appendChild(baseOption);

                        data.conversions.forEach(conv => {
                            if (conv.from !== conv.to && conv.from !== data.base_unit) {
                                const option = document.createElement("option");
                                option.value = conv.from;
                                option.textContent = conv.from;
                                unitSelect.appendChild(option);
                            }
                        });
                        const quantityInput = document.querySelector("#quantityInput");
                        quantityInput.value = 100;

                        updateMacros()
                    });
                }
            });
            document.querySelector("#quantityInput").addEventListener("input", updateMacros);
            document.querySelector("#unitSelect").addEventListener("change", updateMacros);

            document.querySelector(".btn-close").onclick = function() {
                document.querySelector("#search").value = "";
                document.querySelector("#search-results").innerHTML = "";
            };

            document.querySelector("#addToLogBtn").onclick = function() {
                fetch("/log-food", {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCSRFToken()
                    },
                    body: JSON.stringify({
                        "food_id": currentFoodData.id,
                        "quantity": document.querySelector("#quantityInput").value,
                        "unit": document.querySelector("#unitSelect").value,
                        "calories": currentComputedMacros.calories,
                        "protein": currentComputedMacros.protein,
                        "carbs": currentComputedMacros.carbs,
                        "fats": currentComputedMacros.fats,
                        "date": currentDate.toISOString().split("T")[0]
                    })
                })
                .then(response => response.json())
                .then(data => {
                    window.location.reload();
                });
            };
        });

        function updateMacros(){
                if(!currentFoodData) return;

                const quantity = parseFloat(document.querySelector("#quantityInput").value);
                const selectedUnit = document.querySelector("#unitSelect").value;

                let factor = 1;

                if (selectedUnit !== currentFoodData.base_unit) {
                    const conversion = currentFoodData.conversions.find(conv =>
                        conv.from === selectedUnit && conv.to === "g"
                    );
                    if (conversion) {
                        factor = conversion.factor;
                    }
                }

                const mult = (quantity / 100) * factor;

                const calories = (currentFoodData.calories * mult).toFixed(1);
                const protein = (currentFoodData.protein * mult).toFixed(1);
                const fats = (currentFoodData.fats * mult).toFixed(1);
                const carbs = (currentFoodData.carbs * mult).toFixed(1);

                document.querySelector("#calories").textContent = `${isNaN(calories)? 0: calories}kcal`;
                document.querySelector("#macros").textContent = `${ isNaN(protein)? 0: protein }P  ${isNaN(carbs)? 0: carbs}C  ${isNaN(fats)? 0: fats}F`;

                currentComputedMacros = {
                    "calories": parseFloat(calories),
                    "protein": parseFloat(protein),
                    "fats": parseFloat(fats),
                    "carbs": parseFloat(carbs)
                };

        }

        function getCSRFToken() {
            let cookieValue = null;
            const name = 'csrftoken';
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let cookie of cookies) {
                    cookie = cookie.trim();
                    if (cookie.startsWith(name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        
    </script>
        <br>
        <ul class="nav justify-content-center">
            <li class="nav-item">
              <a style="cursor: pointer;" class="nav-link" aria-current="page" id="previous"><</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" aria-current="page" href="#" id="current">{{date | date:"F j, Y"}}</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="#" id="next">></a>
            </li>
        </ul>
    <div class="card" style="margin-top: 20px;">
        <div class="card-body" style="margin: 20px;">
            <div class="mb-3">
                <h1>Calories:</h1>
                <h3 id="caloriesText">{{daily_log.calories |floatformat:0}} / {{ profile.target_calories }}</h3>
                <div class="progress" role="progressbar" aria-label="Basic example" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
                    <div class="progress-bar calories" style="width: {{ percentage_calories|default:0 }}%"></div>
                </div>
            </div>
            <div class="mb-3">
                <h2>Protein:</h2>
                <h3 id="proteinText">{{daily_log.protein|floatformat:0}} / {{ profile.target_protein }}</h3>
                <div class="progress" role="progressbar" aria-label="Basic example" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
                    <div class="progress-bar protein" style="width: {{ percentage_protein|default:0 }}%"></div>
                </div>
            </div>
            <div class="mb-3">
                <h2>Carbohydrates:</h2>
                <h3 id="carbsText">{{daily_log.carbs|floatformat:0}} / {{ profile.target_carbs}}</h3>
                <div class="progress" role="progressbar" aria-label="Basic example" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
                    <div class="progress-bar carbs" style="width: {{ percentage_carbs|default:0 }}%"></div>
                </div>
            </div>
            <div class="mb-3">
                <h2>Fats:</h2>
                <h3 id="fatsText">{{ daily_log.fats|floatformat:0 }} / {{ profile.target_fats}}</h3>
                <div class="progress" role="progressbar" aria-label="Basic example" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
                    <div class="progress-bar fats" style="width: {{ percentage_fats|default:0 }}%"%"></div>
                </div>
            </div>
        </div>
    </div>
    <div class="mb-3" style="margin-top: 20px;">
        <h1> Meals </h1>
    </div>
    <div class="card" style="margin-top:20px;">
        <div class="card-body" >
            <div class="container text-center">
                <div class="row">
                    <div class="col">
                        <button style="text-decoration: none; background: none; border: none;" data-bs-toggle="modal" data-bs-target="#exampleModal"><h2> Add Food +</h2></button>
                            <div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
                                <div class="modal-dialog modal-xl">
                                    <div class="modal-content">
                                        <div class="modal-header">
                                        <h1 class="modal-title fs-5" id="exampleModalLabel">Add Food</h1>
                                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                        </div>
                                        <div class="modal-body">
                                            <div class="container">
                                                <div class="row">
                                                    <div class="col-11">
                                                        <input class="form-control me-2" type="search" placeholder="Search" aria-label="Search" id="search"/>
                                                    </div>
                                                    <div class="col-1">
                                                        <button class="btn btn-outline-success" type="submit">Search</button>
                                                    </div>
                                                </div>
                                                <div class="row" id="search-results">
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="modal fade" id="foodDetailModal" aria-hidden="true" aria-labelledby="exampleModalToggleLabel2" tabindex="-1" style="text-align: left;">
                            <div class="modal-dialog modal-xl">
                                <div class="modal-content">
                                    <div class="modal-header">
                                        <button style="background: none; border: none; color: black;"  class="btn btn-primary" data-bs-target="#exampleModal" data-bs-toggle="modal"><</button>
                                        <h1 style="margin-left: 5px;" class="modal-title fs-5" id="food-detail-name">Add food</h1>
                                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                    </div>

                                    <div class="modal-body" style="margin:10px;">
                                        <h4 id="modalFoodName"></h4>
                                        <h3 id="modalFoodDetails"></h4>
                                        <input type="hidden" id="selectedFoodId" />
                                        <div class="mb-3">
                                        <label for="quantityInput">Quantity</label>
                                        <input type="number" class="form-control" id="quantityInput">
                                        </div>
                                        <div class="mb-3">
                                        <label for="unitSelect">Unit</label>
                                        <select class="form-select" id="unitSelect"> 
                                        </select>
                                    </div>
                                    
                                    <div class="modal-footer">
                                        <button type="submit" class="btn btn-primary" id="addToLogBtn">Add</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="mb-3" style="margin-top:20px;" id="meals">
        {% include "calorie/entries.html" %}
    </div>
    
    
{% endblock %}